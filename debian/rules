#!/usr/bin/make -f

export DH_VERBOSE = 1

# Build may fail if we don't use the same version as upstream, especially
# when the new versions triggers and update of `pubspec.lock`.
FLUTTER_VERSION = 3.35.4
FLUTTER_VERSION_UPSTREAM = $(shell cat .github/workflows/linux_ci.yml | grep flutter-version | cut -d "'" -f 2)
ifneq ($(FLUTTER_VERSION), $(FLUTTER_VERSION_UPSTREAM))
  $(error Using flutter version $(FLUTTER_VERSION). But upstream builds with $(FLUTTER_VERSION_UPSTREAM))
endif

FLUTTER_PATH = /tmp/flutter-rustup
export PUB_CACHE = $(FLUTTER_PATH)/pub-cache

BLOOMEETUNES_HOME := /tmp/bloomeetunes.HOME
export HOME = $(BLOOMEETUNES_HOME)

ifeq (jammy, $(shell cat /etc/os-release | grep UBUNTU_CODENAME | cut -d "=" -f 2))
  # Required on jammy otherwise we have
  # clang: error: optimization flag '-ffat-lto-objects' is not supported [-Werror,-Wignored-optimization-argument]
  export DEB_BUILD_MAINT_OPTIONS=optimize=-lto
endif

ifeq (bullseye, $(shell cat /etc/os-release | grep VERSION_CODENAME | cut -d "=" -f 2))
  # Required on bullseye otherwise we have
  # /usr/bin/ld: mimalloc/out/release/mimalloc.o: undefined reference to symbol 'pthread_setspecific@@GLIBC_2.2.5'
  # /usr/bin/ld: /lib/x86_64-linux-gnu/libpthread.so.0: error adding symbols: DSO missing from command line
  LDFLAGS = -pthread
endif

$(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable.tar.xz:
	mkdir -p $(FLUTTER_PATH)
	curl https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_$(FLUTTER_VERSION)-stable.tar.xz > $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable.tar.xz

$(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable/.unpacked: $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable.tar.xz
	mkdir -p $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable
	tar -xf $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable.tar.xz -C $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable --strip=1
	touch $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable/.unpacked

ifneq ($(filter pkg.bloomeetunes.downloadrustup,$(DEB_BUILD_PROFILES)),)
  # rustup package is available in Debian since trixie (13), and in Ubuntu since noble (24.04)
  # In previous versions, we have to download and install rustup ourselves.
  # To build on these versions, set DEB_BUILD_PROFILES=pkg.bloomeetunes.downloadrustup
  export CARGO_HOME = $(FLUTTER_PATH)/cargo
  export RUSTUP_HOME = $(FLUTTER_PATH)/rustup
  export PATH := $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable/bin/:$(CARGO_HOME)/bin:$(PATH)
  RUSTUP_BUILD_DEP = $(CARGO_HOME)/bin/rustup.done
else
  export PATH := $(PATH):$(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable/bin/
  RUSTUP_BUILD_DEP =
endif

.PHONY: rustup
rustup: $(RUSTUP_BUILD_DEP)
	# Workaround for https://github.com/rust-lang/rustup/issues/2886#issuecomment-2186859672
	# which appeared on noble
	rustup set auto-self-update disable

$(HOME):
	mkdir -p $(HOME)

$(HOME)/rustup-init.sh: $(HOME)
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -o rustup-init.sh --output-dir $(HOME)

$(CARGO_HOME)/bin/rustup.done: $(HOME)/rustup-init.sh
	sh $(HOME)/rustup-init.sh -y --profile minimal
	touch $(CARGO_HOME)/bin/rustup.done

%: $(HOME)
	dh $@

override_dh_clean:
	dh_clean
	rm -fr $(BLOOMEETUNES_HOME)

override_dh_auto_clean: $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable/.unpacked
	flutter pub get --enforce-lockfile --verbose
	flutter clean --verbose

override_dh_auto_build: $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable/.unpacked rustup
	flutter pub get --enforce-lockfile --verbose
	flutter build linux --verbose

override_dh_auto_test: $(FLUTTER_PATH)/flutter_linux_$(FLUTTER_VERSION)-stable/.unpacked rustup
	flutter test linux --verbose

execute_after_dh_auto_install:
	mkdir -p debian/tmp/usr/share/icons/hicolor/apps/
	cp -a assets/icons/BloomeeLogo4.png debian/tmp/usr/share/icons/hicolor/apps/ls.bloomee.musicplayer.png
	for size in 16 24 32 48 64 128 256; do \
	  mkdir -p debian/tmp/usr/share/icons/hicolor/$${size}x$${size}/apps ; \
	  convert assets/icons/BloomeeLogo4.png -filter Lanczos -resize $${size}x$${size} debian/tmp/usr/share/icons/hicolor/$${size}x$${size}/apps/ls.bloomee.musicplayer.png ; \
	done

override_dh_dwz:
	#Disable, because it fails
	#dh_dwz --no-dwz-multifile
