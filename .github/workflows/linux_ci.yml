name: "Build for Linux"

on:
  workflow_dispatch:
    branches: main

env:
  # add 121 to the GitHub run number so build numbers align with Android/Windows
  build_number_increment: 121
  flutter_version: '3.35.4'

jobs:
  linux_build:
    name: Linux Build
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '${{ env.flutter_version }}'
          channel: stable
      - run: |
          sudo apt-get update -y
          sudo apt-get install -y curl git unzip xz-utils zip libglu1-mesa
          sudo apt-get install -y ninja-build libgtk-3-dev cmake git libmpv-dev clang

      - name: Install Dependencies
        run: flutter pub get
      - name: Extract version from pubspec.yaml
        run: |
          ver=$(grep -m1 -E '^version:\s*' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          if [ -z "$ver" ]; then echo "version not found in pubspec.yaml"; exit 1; fi
          echo "VERSION=$ver" >> $GITHUB_ENV
            
      - name: Create .env file
        run: echo "CLIENT_ID = XXXXX\nCLIENT_SECRET = XXXX EOF" > assets/.env

      - name: Build Linux App
        # compute adjusted build number so linux matches other platforms
        run: |
          adjusted=$(( ${{ github.run_number }} + ${{ env.build_number_increment }} ))
          echo "ADJUSTED_RUN_NUMBER=$adjusted" >> $GITHUB_ENV
          flutter build linux --release --build-number $adjusted

      - name: Zip Linux App
        run: |
          cd build/linux/x64/release/bundle
          zip -r bloomee_tunes_linux_v${{ env.VERSION }}+${{ env.ADJUSTED_RUN_NUMBER }}.zip .
        


      - name: Upload Linux App
        uses: actions/upload-artifact@v4
        with:
          name: bloomee_tunes_linux
          path: build/linux/x64/release/bundle/bloomee_tunes_linux_v${{ env.VERSION }}+${{ env.ADJUSTED_RUN_NUMBER }}.zip

  build-debs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite: [
        ['Debian_bullseye', 'debian:bullseye-slim', 'pkg.bloomeetunes.downloadrustup'],
        ['Debian_bookworm', 'debian:bookworm-slim', 'pkg.bloomeetunes.downloadrustup'],
        ['Debian_trixie', 'debian:trixie-slim', ''],
        ['Ubuntu_jammy', 'ubuntu:jammy', 'pkg.bloomeetunes.downloadrustup'],
        ['Ubuntu_noble', 'ubuntu:noble', ''],
        ['Kali_latest', 'kalilinux/kali-last-release', ''],
        ]
    steps:
      - uses: actions/checkout@v4
      - name: Build version number
        run: |
          ver=$(grep -m1 -E '^version:\s*' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          if [ -z "$ver" ]; then echo "version not found in pubspec.yaml"; exit 1; fi
          # compute adjusted build number so linux matches other platforms
          adjusted=$(( ${{ github.run_number }} + ${{ env.build_number_increment }} ))
          echo "FINAL_VERSION=${ver}+${adjusted}" >> $GITHUB_ENV
      - uses: jtdor/build-deb-action@v1
        env:
          DEB_BUILD_OPTIONS: noautodbgsym
          DEB_BUILD_PROFILES: ${{ matrix.suite[2] }}
        with:
          before-build-hook: |
            apt-get -y install lsb-release devscripts distro-info

            CODENAME="${DISTRIB:=$(lsb_release -cs)}" # trixie
            RELEASE_DEBIAN="$(debian-distro-info -r --series "$CODENAME" || true)" # Don't fail if not found, it may be ubuntu...
            RELEASE_UBUNTU="$(ubuntu-distro-info -r --series "$CODENAME" || true)" #
            RELEASE_UBUNTU="${RELEASE_UBUNTU%% *}" # remove LTS suffix present in ubuntu (eg. "24.04" LTS -> "24.04")
            RELEASE="${RELEASE_DEBIAN}${RELEASE_UBUNTU}"
            RELEASE="${RELEASE:=$(cat /etc/debian_version)}" # If neither Debian, nor Ubuntu, put value of /etc/debian_version
            #LOCAL_SUFFIX="~bpo${RELEASE}+ci${{ github.run_id }}~git$(git rev-parse --short HEAD)"
            LOCAL_SUFFIX="~bpo${RELEASE}~git$(git rev-parse --short HEAD)"

            #debchange --force-bad-version --controlmaint --local="${LOCAL_SUFFIX}" "CI build"
            debchange --force-bad-version --controlmaint --newversion="${{ env.FINAL_VERSION }}-1${LOCAL_SUFFIX}" "CI build"
          buildpackage-opts: --build=binary --no-sign
          docker-image: ${{ matrix.suite[1] }}
      - name: Archive artifacts for ${{ matrix.suite[0] }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bloomee_tunes_${{ matrix.suite[0] }}
          path: 'debian/artifacts/*'
          if-no-files-found: ignore
